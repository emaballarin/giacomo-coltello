---
title: "SMDS Homework - Block 3"
author: "R. Corti, L. Taroni, J.A. Fernandez Santisteban and E. Ballarin  |  Group 'D'"
date: "13th May 2020"
output:
  html_document:
    theme: darkly
    highlight: breezedark
    mathjax: default
    self_contained: true
    md_extensions: +autolink_bare_uris
    toc: true
    toc_collapsed: false
    toc_float: true
    toc_depth: 3
    number_sections: false
header-includes:
- \usepackage{color}
- \usepackage{graphicx}
- \usepackage{grffile}
institute: University of Trieste, SISSA, ICTP, University of Udine
graphics: yes
fontsize: 10pt
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(fig.align = 'center', warning=FALSE, message=FALSE, fig.asp=0.625, dev='png', global.par = TRUE, dev.args=list(pointsize=10), fig.path = 'figs/')
```

```{r setup, include=FALSE}
library(knitr)
local({
  hook_plot = knit_hooks$get('plot')
  knit_hooks$set(plot = function(x, options) {
    paste0('\n\n----\n\n', hook_plot(x, options))
  })
})
```

# Exercises from *LEC*

## Exercise 1

## Exercise 2

### Text:
Compute *bootstrap*-based confidence intervals for the $\mathsf{score}$ dataset using the $\mathsf{boot}$ package.

### Solution:

Hello!


# Exercises from *LAB*

## Exercise 1

## Exercise 2

**The Wald confidence interval with level $1−\alpha$ is defined as**:
$$ \hat{\gamma} \pm z_{1-\alpha/2}j_{P}(\hat{\gamma})^{-1/2}.$$

**Compute the Wald confidence interval of level 0.95 and plot the results.**

In order to have the profile likelihood, let's consider the vector $y$ and the log-likelihood of the Weibull Model $l(\gamma, \beta)$:
```{r echo=TRUE,  message=FALSE, warning=FALSE}

y <- c(155.9, 200.2, 143.8, 150.1,152.1, 142.2, 147, 146, 146,
       170.3, 148, 140, 118, 144, 97)
n <- length(y)

log_lik_weibull <- function( data, param){
  -sum(dweibull(data, shape = param[1], scale = param[2], log = TRUE))
}
```


Given this function, the profile likelihood $l_P(\gamma)$ is built evaluating the log-likelihood to $y, \gamma$ and  $\hat{\beta}_{\gamma}= (\sum_{i=1}^{n} y^{\gamma}_{i}/n)^{1/\gamma}$:

```{r echo=TRUE,  message=FALSE, warning=FALSE}
log_lik_weibull_profile_gamma  <- function(data, gamma){
  beta.gamma <- mean(data^gamma)^(1/gamma)
  log_lik_weibull( data, c(gamma, beta.gamma) )
}
```

After having defined the above function, we find the MLE $\hat{\gamma}$ using the $\mathsf{optim()}$ numerical method specifying `hessian=T`. Then, the Wald interval will be defined as $\hat{\gamma} \pm z_{1-\alpha/2}j_{P}(\hat{\gamma})^{-1/2}$, where $j_{P}(\hat{\gamma})$ is the hessian evaluated at $\gamma = \hat{\gamma}$:
```{r echo=TRUE,  message=FALSE, warning=FALSE}
weib_mle<-optim(1 ,fn=log_lik_weibull_profile_gamma,hessian=T,
                  method='L-BFGS-B',lower=rep(1e-7,2),
                  upper=rep(Inf,2),data=y)
weib_mle$par

weib_mle_se<-(weib_mle$hessian[1,1])^(-1/2)
conf_level <- 0.95
weib_mle_ci <- weib_mle$par + c(-1,1)* weib_mle_se * qnorm(1-(1-conf_level)/2)
weib_mle_ci
```

```{r echo=TRUE,  message=FALSE, warning=FALSE}
log_lik_weibull_profile_gamma_v <-Vectorize(log_lik_weibull_profile_gamma, 'gamma'  )
plot(function(x) -log_lik_weibull_profile_gamma_v(data=y, x)+weib_mle$value,
     from=0.1,to=15,xlab=expression(gamma),
     ylab='profile relative log likelihood',ylim=c(-8,0))


segments(x0=weib_mle_ci[1], y0=-log_lik_weibull_profile_gamma_v(y,weib_mle_ci[1])+weib_mle$value,
         x1= weib_mle_ci[1], y1=-10,  col="green", lty=2)

segments(x0=weib_mle_ci[2], y0=-log_lik_weibull_profile_gamma_v(y,weib_mle_ci[2])+weib_mle$value, x1= weib_mle_ci[2], y1=-10,  col="green", lty=2)

abline(v=weib_mle$par[1], col="green", lwd=1, lty=1)
text(10, -1, "MLE for Gamma", col="green")
text(7,-7,"95% Wald CI",col="green")
segments( weib_mle_ci[1], -6.7, weib_mle_ci[2], -6.7, col="green", lty =1, lwd=2  )
```

## Exercise 3

**Repeat the steps above —write the profile log-likelihood, plot it and find the deviance confidence intervals— considering this time $\gamma$ as a nuisance parameter and $\beta$ as the parameter of interest.**

In order to evaluate the profile log-likelihood for $\gamma$ as a nuisance parameter and $\beta$ as the parameter of interest we noticed that $\gamma$ is note explicitly expressed in terms of $\beta$. We used the numerical method $\mathsf{uniroot()}$  in order to fix $\gamma = \hat{\gamma}$, since we know that this estimator satisfies for every $\beta$:

$$ \frac{n}{\hat{\gamma}} - n \log(\beta) + \sum_i(\log(y_i)) - \sum_i\Bigg[\bigg(\frac{y_i}{\beta}\bigg)^{\hat{\gamma}} \log\bigg(\frac{y_i}{\beta}\bigg) \Bigg] = 0 $$
Subsequently we proceed to compute the deviance confidence intervals with level $1-\alpha$ as:

$$\{\beta: \ell_P(\beta) \geq \ell_P(\hat \beta) - \frac{1}{2}\chi^2_{1;1-\alpha}\}$$
```{r echo=TRUE,  message=FALSE, warning=FALSE}
gamma <- seq(0.1, 15, length=100)
beta <- seq(100,200, length=100)

weib_mle<-optim(c(1,1),fn=log_lik_weibull,hessian=T,
                  method='L-BFGS-B',lower=rep(1e-7,2),
                  upper=rep(Inf,2),data=y)

log_lik_weibull_profile_beta <- function(data, beta) {
  gamma.beta <- uniroot(function(x) n/x - n * log(beta) + sum(log(data)) - sum((data/beta)^x * log(data/beta)), c(1e-5,15))$root
  log_lik_weibull(data, c(gamma.beta, beta))
}
```


```{r echo=TRUE,  message=FALSE, warning=FALSE}
log_lik_weibull_profile_beta_vec <-Vectorize(log_lik_weibull_profile_beta, 'beta')

plot(function(x) -log_lik_weibull_profile_beta_vec(data=y, x) + weib_mle$value, from=120,to=200, xlab=expression(beta),
    ylab='profile relative log likelihood', ylim=c(-10,0))

conf.level<-0.95
lrt.ci1<-uniroot(function(x) -log_lik_weibull_profile_beta(data = y, x)+
                   weib_mle$value+
                   qchisq(conf.level,1)/2,
                 c(1e-7,weib_mle$par[2]))$root


lrt.ci1<-c(lrt.ci1,uniroot(function(x) -log_lik_weibull_profile_beta(y,x)+
                             weib_mle$value+
                             qchisq(conf.level,1)/2,
                           c(weib_mle$par[2],200))$root)

abline(h=-qchisq(conf.level,1)/2,lty='dashed',col=2)
segments( lrt.ci1[1],-qchisq(conf.level,1)/2, lrt.ci1[1], 
          -log_lik_weibull_profile_beta_vec(y, lrt.ci1[1]), col="red", lty=2  )
segments( lrt.ci1[2],-qchisq(conf.level,1)/2, lrt.ci1[2],
          -log_lik_weibull_profile_beta_vec(y, lrt.ci1[2]), col="red", lty=2  )
points(lrt.ci1[1], -qchisq(0.95,1)/2, pch=16, col=2, cex=1.5)
points(lrt.ci1[2], -qchisq(0.95,1)/2, pch=16, col=2, cex=1.5)
segments( lrt.ci1[1],
          -8.1, lrt.ci1[2],
          -8.1, col="red", lty =1, lwd=2  )
text(155,-7.5,"95% Deviance CI",col=2)
```

## Exercise 5

## Exercise 6

## Exercise 7

## Exercise 8

**Go to this link: [rstan](https://github.com/stan-dev/rstan/wiki/RStan-Getting-Started), and follow the instructions to download and install the rstan library. Once you did it succesfully, open the file model called biparametric.stan, and replace the line**

$$ \mathsf{ target+=cauchy\_lpdf(sigma| 0, 2.5);} $$ 
**with the following one:**

$$ \mathsf{ target+=uniform_lpdf(sigma|0.1,10);} $$
**Which prior are you now assuming for your parameter $\sigma$ ? Reproduce the same plots as above and briefly comment.**

The `biparametric.stan` file used has the following structure:
```
data{
  int N;
  real y[N];
  real a;
  real b;
}
parameters{
  real theta;
  real<lower=0> sigma;
}
model{
  target+=normal_lpdf(y|theta, sigma);
  target+=uniform_lpdf(theta|a, b );
  target+=uniform_lpdf(sigma|0.1,10);
}
```
In this case we're assuming that the parameter $\sigma$ has a prior distribution that is Uniform in the interval $[0.1,10]$
```{r echo=TRUE,  message=FALSE, warning=FALSE}
#input values

#true mean
theta_sample <- 2
#likelihood variance
sigma2 <- 2
#sample size
n <- 10

#generate some data
set.seed(123)
y <- rnorm(n,theta_sample, sqrt(sigma2))
```

```{r echo=TRUE,  message=FALSE, warning=FALSE}
library(rstan)
library(bayesplot)
library(rstanarm)
library(ggplot2)


data3<- list(N=n, y=y, a=-10, b=10)
fit3 <- stan(file="./src/biparametric.stan", data = data3, chains = 4, iter=2000,
             refresh=-1)
#extract stan output for biparametric model
sim3 <- extract(fit3)
posterior_biv <- as.matrix(fit3)
theta_est <- mean(sim3$theta)
sigma_est <- mean(sim3$sigma)
#mean of the samples
c(theta_est, sigma_est)
```

Once we have the MCMC samples, we represent the result with `mcmc_areas`: 
```{r echo=TRUE,  message=FALSE, warning=FALSE}
plot_title <- ggtitle("Posterior distributions", "with medians and 80% intervals")
mcmc_areas(posterior_biv, pars = c("theta","sigma"), prob = 0.8) + plot_title
```

From the result of the MCMC sampling we observe that mean and variance results for both $\theta$ and $\sigma$ are slightly different from the case in wich $\sigma \sim \text{Cauchy}^+ (0,2.5)$. This result suggests that priors used don't provide much information to the posterior distributions.

## Exercise 9

## Exercise 10
